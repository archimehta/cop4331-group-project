<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Contact Manager – Contact Management</title>
</head>
<body>
  <!-- top right -->
  <div>
    <a href="#" id="logout-link">Log out</a>
  </div>

  <h1>Edit Contacts</h1>

  <div style="display:flex; gap:24px; align-items:flex-start;">
    <!-- Add Contact -->
    <section>
      <h2 style="margin:0;">Add Contact</h2>

      <form id="add-form" novalidate>
        <div>
          <label for="add-email">Email:</label><br/>
          <input id="add-email" name="email" type="email" placeholder="email@domain.com">
        </div>
        <br/>

        <div>
          <label for="add-phone">Phone Number:</label><br/>
          <input id="add-phone" name="phone" type="text" placeholder="(000)-000-0000">
        </div>
        <br/>

        <div>
          <label for="add-first">First Name:</label><br/>
          <input id="add-first" name="firstName" type="text">
        </div>
        <br/>

        <div>
          <label for="add-last">Last Name:</label><br/>
          <input id="add-last" name="lastName" type="text">
        </div>
        <br/>

        <button type="submit" id="add-btn">Add</button>
      </form>

      <p id="add-status"></p>
    </section>

    <!-- Search + list -->
    <section style="flex:1;">
      <div>
        <input id="search" type="text" placeholder="Search for...">
      </div>
      <div id="search-status" style="margin-top:6px;"></div>

      <div id="results" style="margin-top:12px;" aria-live="polite"></div>
      <!-- infinite scroll -->
      <div id="sentinel"></div>
    </section>
  </div>

  <script>
    // local storage
    const USER_ID = Number(localStorage.getItem('userId')) || 0;
    /*if (!USER_ID) {
      // not logged in -> back to auth
      window.location.href = 'auth.html';
    }*/

    document.getElementById('logout-link').addEventListener('click', (e) => {
      e.preventDefault();
      localStorage.clear();
      window.location.href = 'auth.html';
    });

    function setAddStatus(msg)   { document.getElementById('add-status').textContent   = msg || ''; }
    function setSearchStatus(msg){ document.getElementById('search-status').textContent = msg || ''; }

    function fullName(item) {
      return [item.FirstName || '', item.LastName || ''].filter(Boolean).join(' ') || '(No name)';
    }

    // add contact
    document.getElementById('add-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      setAddStatus('');

      const email = document.getElementById('add-email').value.trim();
      const phone = document.getElementById('add-phone').value.trim();
      const first = document.getElementById('add-first').value.trim();
      const last  = document.getElementById('add-last').value.trim();

      if(!email || !phone){
         setAddStatus('Email and phone number are required.');
        return;
      }

      if (!first || !last) {
        setAddStatus('First and last name are required.');
        return;
      }
      

      try {
        const res = await fetch('AddContact.php', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({
            userId: USER_ID,
            firstName: first,
            lastName:  last,
            phone:     phone,
            email:     email
          })
        });
        const data = await res.json().catch(() => ({}));
        if (!res.ok || data.error) {
          setAddStatus(data.error || 'Add failed.');
          return;
        }

        // clear form, show message, and refresh current search
        document.getElementById('add-form').reset();
        setAddStatus('Contact added.');
        // re-run search with current query to include the new contact
        triggerSearch();
      } catch (err) {
        console.error(err);
        setAddStatus('Unexpected error while adding contact.');
      }
    });

    // search
    const PAGE_SIZE = 20;
    const searchEl  = document.getElementById('search');
    const resultsEl = document.getElementById('results');
    const sentinel  = document.getElementById('sentinel');

    let allResults = [];     // full array returned by the API
    let renderIndex = 0;     // index into all results for incremental render
    let lastQuery   = '';    // last query string used
    let debounceId  = null;  // debounce timer id

    function clearList() {
      resultsEl.textContent = '';
      renderIndex = 0;
    }

    function renderNextPage() {
      if (renderIndex >= allResults.length) return;

      const end = Math.min(renderIndex + PAGE_SIZE, allResults.length);
      for (let i = renderIndex; i < end; i++) {
        const c = allResults[i];

        const row = document.createElement('div');
        row.style.margin = '8px 0';

        const text = document.createElement('span');
        text.innerHTML = `<strong>${fullName(c)}</strong>` +
                         (c.Phone || c.Email ? ` — ${[c.Phone, c.Email].filter(Boolean).join(' • ')}` : '');
        row.appendChild(text);

        // Edit button -> edit.html?id=...
        const editBtn = document.createElement('button');
        editBtn.textContent = 'Edit';
        editBtn.style.marginLeft = '8px';
        editBtn.addEventListener('click', () => {
          window.location.href = `edit.html?id=${encodeURIComponent(c.databaseId)}`;
        });
        row.appendChild(editBtn);

        resultsEl.appendChild(row);
      }

      renderIndex = end;
      if (renderIndex >= allResults.length) {
        setSearchStatus(allResults.length ? 'End of results.' : '');
      }
    }

    async function performSearch(query) {
      setSearchStatus('Searching…');
      clearList();
      allResults = [];

      try {
        const res = await fetch('SearchContacts.php', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ search: query, userId: USER_ID })
        });
        const data = await res.json().catch(() => ({}));

        if (!res.ok) {
          setSearchStatus(data.error || 'Search failed.');
          return;
        }
        if (typeof data.error === 'string' && data.error !== '') {
          setSearchStatus(data.error);
          return;
        }

        allResults = Array.isArray(data.results) ? data.results : [];
        setSearchStatus(allResults.length ? '' : 'No contacts found.');
        renderNextPage(); // initial page
      } catch (err) {
        console.error(err);
        setSearchStatus('Unexpected error during search.');
      }
    }

    // Debounced input handler
    function triggerSearch() {
      const q = searchEl.value.trim();
      if (q === lastQuery) return;
      lastQuery = q;

      if (q.length >= 1) {
        performSearch(q);
      } else {
        clearList();
        setSearchStatus('Type to search.');
      }
    }

    searchEl.addEventListener('input', () => {
      clearTimeout(debounceId);
      debounceId = setTimeout(triggerSearch, 300);
    });

    // infinite scroll 
    const io = new IntersectionObserver(entries => {
      for (const e of entries) {
        if (e.isIntersecting) {
          renderNextPage();
        }
      }
    });
    io.observe(sentinel);

    // initial hint
    setSearchStatus('Type to search.');
    searchEl.focus();
  </script>
</body>
</html>
